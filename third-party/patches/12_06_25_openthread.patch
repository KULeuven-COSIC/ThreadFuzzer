From dcf47d2c992615e86124abb79e79138988dcbd91 Mon Sep 17 00:00:00 2001
From: JakoCrafter <j.heirweghjh.jh@gmail.com>
Date: Thu, 12 Jun 2025 21:35:24 +0200
Subject: [PATCH] june_12_25

---
 examples/platforms/simulation/radio.c |  8 ++++++++
 examples/platforms/simulation/uart.c  |  5 +++++
 script/cmake-build                    | 29 ++++++++++++++++++++++++++-
 3 files changed, 41 insertions(+), 1 deletion(-)

diff --git a/examples/platforms/simulation/radio.c b/examples/platforms/simulation/radio.c
index 9fe37b66c..a3f58e8e1 100644
--- a/examples/platforms/simulation/radio.c
+++ b/examples/platforms/simulation/radio.c
@@ -29,6 +29,9 @@
 #include "platform-simulation.h"
 
 #include <errno.h>
+// THREADFUZZ: for fd configuration (START)
+#include <fcntl.h>
+// THREADFUZZ: for fd configuration (END)
 #include <sys/time.h>
 
 #include <openthread/cli.h>
@@ -465,6 +468,11 @@ static void initFds(void)
     // Rx fd is successfully initialized.
     sRxFd = fd;
 
+    // THREADFUZZ: prevent fd overflow (START)
+    fcntl(sTxFd, F_SETFD, FD_CLOEXEC);
+    fcntl(sRxFd, F_SETFD, FD_CLOEXEC);
+    // THREADFUZZ: prevent fd overflow (END)
+
 exit:
     if (sRxFd == -1 || sTxFd == -1)
     {
diff --git a/examples/platforms/simulation/uart.c b/examples/platforms/simulation/uart.c
index fe3fcebe8..94a45c961 100644
--- a/examples/platforms/simulation/uart.c
+++ b/examples/platforms/simulation/uart.c
@@ -74,6 +74,11 @@ otError otPlatUartEnable(void)
     s_out_fd = dup(STDOUT_FILENO);
     dup2(STDERR_FILENO, STDOUT_FILENO);
 
+    // THREADFUZZ: prevent fd overflow (START)
+    fcntl(s_in_fd, F_SETFD, FD_CLOEXEC);
+    fcntl(s_out_fd, F_SETFD, FD_CLOEXEC);
+    // THREADFUZZ: prevent fd overflow (END)
+
     // We need this signal to make sure that this
     // process terminates properly.
     signal(SIGPIPE, SIG_DFL);
diff --git a/script/cmake-build b/script/cmake-build
index e457bfcd1..fd2bc8598 100755
--- a/script/cmake-build
+++ b/script/cmake-build
@@ -83,7 +83,9 @@ OT_POSIX_SIM_COMMON_OPTIONS=(
     "-DOT_COAP_OBSERVE=ON"
     "-DOT_COMMISSIONER=ON"
     "-DOT_COMPILE_WARNING_AS_ERROR=ON"
-    "-DOT_COVERAGE=ON"
+    # THREADFUZZ: disable coverage (START)
+    "-DOT_COVERAGE=OFF"
+    # THREADFUZZ: disable coverage (END)
     "-DOT_DATASET_UPDATER=ON"
     "-DOT_DHCP6_CLIENT=ON"
     "-DOT_DHCP6_SERVER=ON"
@@ -96,6 +98,9 @@ OT_POSIX_SIM_COMMON_OPTIONS=(
     "-DOT_JAM_DETECTION=ON"
     "-DOT_JOINER=ON"
     "-DOT_LOG_LEVEL_DYNAMIC=ON"
+    # THREADFUZZ: allow logging to file (START)
+    "-DOT_LOG_OUTPUT=PLATFORM_DEFINED"
+    # THREADFUZZ: allow logging to file (END)
     "-DOT_MAC_FILTER=ON"
     "-DOT_NEIGHBOR_DISCOVERY_AGENT=ON"
     "-DOT_NETDATA_PUBLISHER=ON"
@@ -108,6 +113,28 @@ OT_POSIX_SIM_COMMON_OPTIONS=(
     "-DOT_SRP_CLIENT=ON"
     "-DOT_SRP_SERVER=ON"
     "-DOT_UPTIME=ON"
+    # THREADFUZZ: allow BR packets (START)
+    "-DOT_BACKBONE_ROUTER=ON"
+    "-DOT_BACKBONE_ROUTER_MULTICAST_ROUTING=ON"
+    "-DOT_BORDER_ROUTER=ON"
+    "-DOT_BORDER_ROUTING=ON"
+    "-DOT_BORDER_ROUTING_DHCP6_PD=ON"
+    "-DOT_BORDER_ROUTING_COUNTERS=ON"
+    "-DOT_NAT64_BORDER_ROUTING=ON"
+    "-DOT_BORDER_AGENT=ON"
+    "-DOT_MLR=ON"
+    "-DOT_UDP_FORWARD=ON"
+    "-DOT_COAP_BLOCK=ON"
+    "-DOT_DNSSD_SERVER=ON"
+    "-DOT_NETDATA_PUBLISHER=ON"
+    "-DOT_SRP_SERVER=ON"
+    "-DOT_TREL=OFF"
+    "-DOT_TCP=ON"
+    "-DOT_POWER_SUPPLY=EXTERNAL"
+    "-DOT_DEVICE_PROP_LEADER_WEIGHT=ON"
+    "-DOT_MLE_MAX_CHILDREN=32"
+    "-DOT_HISTORY_TRACKER=ON"
+    # THREADFUZZ: allow BR packets (END)
 )
 readonly OT_POSIX_SIM_COMMON_OPTIONS
 
-- 
2.43.0

